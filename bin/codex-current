#!/usr/bin/env bash
# CURRENT 2025 ONLY - Web search with strict date filtering
# Today is September 18, 2025

set -euo pipefail

PROMPT="${1:?Usage: codex-current <query>}"
TODAY="September 18, 2025"
CUTOFF="June 2025"  # Last 100 days from today

# Always append date context to queries
DATED_PROMPT="$PROMPT (current as of $TODAY, only information from $CUTOFF or newer, exclude 2024 and older)"

echo "🔍 Searching CURRENT 2025 info only (since $CUTOFF)..." >&2

# Try Perplexity first with date filtering
if [[ -n "${PERPLEXITY_API_KEY:-}" ]]; then
  RESPONSE=$(curl -s -X POST https://api.perplexity.ai/chat/completions \
    -H "Authorization: Bearer $PERPLEXITY_API_KEY" \
    -H "Content-Type: application/json" \
    -d "{
      \"model\": \"sonar\",
      \"messages\": [
        {\"role\": \"system\", \"content\": \"Today is $TODAY. ONLY provide information from 2025, specifically from June 2025 onwards. Reject and warn about any information from 2024 or earlier.\"},
        {\"role\": \"user\", \"content\": \"$DATED_PROMPT\"}
      ]
    }")

  echo "$RESPONSE" | jq -r '.choices[0].message.content // .error.message'
  exit 0
fi

# Fallback to Brave with date filtering
if [[ -n "${BRAVE_API_KEY:-}" ]]; then
  echo "Using Brave Search with 2025 filter..." >&2

  QUERY=$(echo "$DATED_PROMPT" | jq -sRr @uri)
  # Add freshness parameter for recent results
  SEARCH_RESULTS=$(curl -s -X GET \
    "https://api.search.brave.com/res/v1/web/search?q=$QUERY&freshness=month" \
    -H "X-Subscription-Token: $BRAVE_API_KEY")

  CONTEXT=$(echo "$SEARCH_RESULTS" | jq -r '
    .web.results[:5] |
    map(select(.age | contains("2025"))) |
    map("Title: " + .title + "\nURL: " + .url + "\nDate: " + .age + "\nSnippet: " + .description) |
    join("\n\n")
  ')

  if [[ -z "$CONTEXT" || "$CONTEXT" == "null" ]]; then
    echo "⚠️ No 2025 results found. The information might be outdated."
    exit 1
  fi

  # Pass to GPT-5 with strict instructions
  curl -s -X POST https://api.openai.com/v1/chat/completions \
    -H "Authorization: Bearer ${OPENAI_API_KEY:-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}" \
    -H "Content-Type: application/json" \
    -d "{
      \"model\": \"gpt-5-mini\",
      \"messages\": [
        {\"role\": \"system\", \"content\": \"Today is $TODAY. Based on these 2025 search results ONLY, answer the question. Reject any information from 2024 or earlier.\"},
        {\"role\": \"user\", \"content\": \"2025 Results:\\n$CONTEXT\\n\\nQuestion: $PROMPT\"}
      ],
      \"temperature\": 1,
      \"max_completion_tokens\": 2000
    }" | jq -r '.choices[0].message.content'

  exit 0
fi

echo "❌ No web search API configured for current 2025 searches!" >&2
exit 1