#!/usr/bin/env bash
# Codex with real web search capability via Perplexity API
set -euo pipefail

PROMPT="${1:?Usage: codex-search <prompt>}"
PERPLEXITY_KEY="${PERPLEXITY_API_KEY:-}"

if [[ -z "$PERPLEXITY_KEY" ]]; then
  echo "❌ Error: PERPLEXITY_API_KEY not set" >&2
  echo "Add to ~/.config/payready/env.llm: PERPLEXITY_API_KEY=your-key" >&2
  exit 1
fi

echo "🔍 Searching web via Perplexity..." >&2

# Call Perplexity for web search
RESPONSE=$(curl -s -X POST https://api.perplexity.ai/chat/completions \
  -H "Authorization: Bearer $PERPLEXITY_KEY" \
  -H "Content-Type: application/json" \
  -d "{
    \"model\": \"sonar\",
    \"messages\": [{\"role\": \"user\", \"content\": \"$PROMPT\"}]
  }")

echo "$RESPONSE" | jq -r '.choices[0].message.content // .error.message'