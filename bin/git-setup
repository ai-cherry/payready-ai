#!/bin/bash
# GitHub setup and authentication helper
# Date: September 18, 2025

set -e

# Load GitHub configuration
source ~/.config/payready/env.github 2>/dev/null || true

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîß PayReady AI GitHub Configuration${NC}"
echo "========================================="

# Function to configure token authentication
configure_token_auth() {
    echo -e "${YELLOW}Setting up token authentication...${NC}"

    # Configure git to use token for HTTPS
    git config --global credential.helper store

    # Set up token authentication in git config
    git config --global url."https://${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

    echo -e "${GREEN}‚úÖ Token authentication configured${NC}"
}

# Function to test GitHub connection
test_connection() {
    echo -e "${YELLOW}Testing GitHub connection...${NC}"

    # Try to fetch repository info using token
    if curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
           -H "Accept: application/vnd.github.v3+json" \
           https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO} > /dev/null; then
        echo -e "${GREEN}‚úÖ GitHub API connection successful${NC}"
    else
        echo -e "${RED}‚ùå Failed to connect to GitHub API${NC}"
        return 1
    fi
}

# Function to add SSH key to GitHub
add_ssh_key() {
    echo -e "${YELLOW}Adding SSH key to GitHub...${NC}"

    SSH_KEY=$(cat ~/.ssh/id_ed25519_payready.pub)

    # Add SSH key via GitHub API
    curl -X POST \
         -H "Authorization: token ${GITHUB_TOKEN}" \
         -H "Accept: application/vnd.github.v3+json" \
         https://api.github.com/user/keys \
         -d "{\"title\":\"PayReady AI - $(hostname)\",\"key\":\"${SSH_KEY}\"}" \
         2>/dev/null

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ SSH key added to GitHub${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  SSH key may already exist or failed to add${NC}"
    fi
}

# Main menu
case "${1:-setup}" in
    setup)
        configure_token_auth
        test_connection
        add_ssh_key

        echo ""
        echo -e "${GREEN}üìã Configuration Summary:${NC}"
        echo "  Repository: https://github.com/${GITHUB_USER}/${GITHUB_REPO}"
        echo "  User: ${GITHUB_USER}"
        echo "  Token: ***$(echo ${GITHUB_TOKEN: -4})"
        echo ""
        echo "  SSH Public Key:"
        echo "  $(cat ~/.ssh/id_ed25519_payready.pub)"
        echo ""
        echo -e "${GREEN}Next Steps:${NC}"
        echo "  1. Add SSH key to GitHub: https://github.com/settings/keys"
        echo "  2. Test push: git push -u origin main"
        ;;

    test)
        test_connection

        # Test SSH connection
        echo -e "${YELLOW}Testing SSH connection...${NC}"
        ssh -T git@github.com 2>&1 | grep -q "successfully" && \
            echo -e "${GREEN}‚úÖ SSH connection successful${NC}" || \
            echo -e "${YELLOW}‚ö†Ô∏è  SSH not configured (use token auth)${NC}"
        ;;

    push)
        echo -e "${YELLOW}Pushing to GitHub...${NC}"
        git push -u origin main
        ;;

    *)
        echo "Usage: git-setup [setup|test|push]"
        echo "  setup - Configure GitHub authentication"
        echo "  test  - Test GitHub connection"
        echo "  push  - Push to GitHub repository"
        ;;
esac